<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LocalServe – Find Local Services</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css?family=Segoe+UI:400,700&display=swap" rel="stylesheet">
  <style>
    /* your CSS untouched, shortened here for clarity */
  </style>
</head>
<body>
  <header class="main-header">
    <h1>Find trusted local services near you</h1>
    <p>From bakers to plumbers – all in one place</p>
  </header>

  <!-- Categories -->
  <div class="categories" id="categoryList">
    <div class="category-card" data-category="Gardening">
      <img src="images/gardening.png" alt="Gardening">
      <span>Gardening</span>
    </div>
    <div class="category-card" data-category="Plumbing">
      <img src="images/plumbing.png" alt="Plumbing">
      <span>Plumbing</span>
    </div>
    <div class="category-card" data-category="Electrical">
      <img src="images/electrical.png" alt="Electrical">
      <span>Electrical</span>
    </div>
    <div class="category-card" data-category="Baking">
      <img src="images/Baking.png" alt="Baking">
      <span>Baking</span>
    </div>
  </div>
  
  <!-- Business Form -->
  <div class="form-container fade-in">
    <h2>List Your Business</h2>
    <form id="businessForm" autocomplete="off">
      <div class="form-group">
        <label for="businessName">Business Name</label>
        <input type="text" id="businessName" name="businessName" required>
      </div>
      <div class="form-group">
        <label for="type">Type of Service</label>
        <input type="text" id="type" name="type" placeholder="e.g. Plumbing, Baking" required>
      </div>
      <div class="form-group">
        <label for="desc">Description</label>
        <textarea id="desc" name="desc" rows="3" required></textarea>
      </div>
      <div class="form-group">
        <label for="phone">Phone Number</label>
        <input type="tel" id="phone" name="phone" required pattern="[0-9\s()-]{7,}">
      </div>
      <div class="form-group">
        <label for="location">Business Location</label>
        <input type="text" id="location" name="location" required placeholder="Business Location">
      </div>
      <div class="form-group">
        <label>Plan</label>
        <div class="plan-options">
          <label>
            <input type="radio" name="plan" value="Standard" checked>
            <b>Standard</b> (R200)
            <p style="font-size: 0.93em; margin: 5px 0 0 0; color:#375;">Get your business listed</p>
          </label>
          <label>
            <input type="radio" name="plan" value="Premium">
            <b>Premium</b> (R300)
            <p style="font-size: 0.93em; margin: 5px 0 0 0; color:#375;">Your Business is first to pop up in selected category</p>
          </label>
          <label>
            <input type="radio" name="plan" value="Yearly">
            <b>Yearly Plan</b> (R2500)
            <p style="font-size: 0.94em; margin: 5px 0 0 0; color:#375;">Pay once, no monthly payments, listed for 12 months</p>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label for="images">Upload Photos (max 5)</label>
        <input type="file" id="images" name="images" accept="image/*" multiple required>
        <div id="imagePreview" style="margin-top:10px; display:flex; gap:6px; flex-wrap:wrap;"></div>
      </div>
      <button type="submit" class="submit-button">Submit Business</button>
      <div id="formError" style="color:red;margin-top:13px;display:none;"></div>
    </form>
  </div>

  <script>
    // CATEGORY CLICK AUTO-FILL
    document.querySelectorAll('.category-card').forEach(card => {
      card.addEventListener('click', function() {
        document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('type').value = this.dataset.category;
        window.scrollTo({top: document.querySelector('.form-container').offsetTop - 20, behavior: 'smooth'});
      });
    });

    // IMAGE PREVIEW
    const imageInput = document.getElementById('images');
    let lastValidFiles = null;
    imageInput.addEventListener('change', function(event) {
      const files = event.target.files;
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      if (files.length > 5) {
        alert('You can only upload a maximum of 5 images.');
        return;
      }
      lastValidFiles = files;
      for (let i = 0; i < files.length; i++) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          preview.appendChild(img);
        };
        reader.readAsDataURL(files[i]);
      }
    });

    // FORM SUBMIT
    document.getElementById('businessForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      document.getElementById('formError').style.display = 'none';

      const businessData = {
        businessName: document.getElementById('businessName').value.trim(),
        type: document.getElementById('type').value.trim(),
        desc: document.getElementById('desc').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        plan: document.querySelector('input[name="plan"]:checked').value,
        location: document.getElementById('location').value.trim(),
        images: []
      };

      // Validation
      if (!businessData.businessName || !businessData.type || !businessData.desc || !businessData.phone || !businessData.location) {
        document.getElementById('formError').textContent = "Fill in all fields.";
        document.getElementById('formError').style.display = '';
        return;
      }

      const imageFiles = document.getElementById('images').files;
      if (imageFiles.length === 0) {
        document.getElementById('formError').textContent = "Please upload at least one image.";
        document.getElementById('formError').style.display = '';
        return;
      }
      if (imageFiles.length > 5) {
        document.getElementById('formError').textContent = "You can only upload up to 5 images.";
        document.getElementById('formError').style.display = '';
        return;
      }

      try {
        // Upload images to Cloudinary
        const uploadPromises = [];
        for (let i = 0; i < imageFiles.length; i++) {
          const formDataImg = new FormData();
          formDataImg.append("file", imageFiles[i]);
          formDataImg.append("upload_preset", "Business Images"); // your Cloudinary preset

          uploadPromises.push(
            fetch("https://api.cloudinary.com/v1_1/dafzrkltz/image/upload", {
              method: "POST",
              body: formDataImg
            }).then(res => res.json())
          );
        }

        const results = await Promise.all(uploadPromises);
        businessData.images = results.map(r => r.secure_url);

        // Send to Google Sheets
        await fetch("https://script.google.com/macros/s/AKfycbwWlh98-yz4TbaBTXvfa10ZlwwvKCkEuibnwX2MHOSRm42GLs1_u_jso9JX_PPzmRhqsw/exec", {
          method: "POST",
          body: JSON.stringify(businessData)
        });

        alert("Business submitted successfully!");
        window.location.href = "preview.html";

      } catch (err) {
        document.getElementById('formError').textContent = "An error occurred. Please try again.";
        document.getElementById('formError').style.display = '';
        console.error(err);
      }
    });
  </script>
</body>
</html>
