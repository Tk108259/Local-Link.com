<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Business Listings</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px}
    .listing{border:1px solid #e1e1e1;padding:12px;margin-bottom:16px;display:flex;gap:12px;align-items:flex-start}
    .gallery{width:320px;max-width:40vw;position:relative}
    .gallery .main{width:100%;height:220px;object-fit:cover;border-radius:6px;background:#f6f6f6}
    .thumbs{display:flex;gap:6px;margin-top:8px;overflow:auto}
    .thumbs img{width:56px;height:42px;object-fit:cover;border-radius:4px;cursor:pointer;opacity:.85;border:2px solid transparent}
    .thumbs img.active{outline:2px solid #3182ce;opacity:1}
    .nav-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.45);color:#fff;border:none;padding:8px;border-radius:4px;cursor:pointer}
    .nav-btn.left{left:6px}
    .nav-btn.right{right:6px}
    .rating{display:flex;gap:4px;align-items:center}
    .stars{display:inline-flex;gap:2px}
    .star{font-size:20px;cursor:pointer;color:#d1d5db}
    .star.selected{color:#f59e0b}
    .meta{flex:1}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .thumbs.hidden{display:none}
    button:focus{outline:2px solid #3182ce}
  </style>
</head>
<body>
  <h1>Business Listings</h1>

  <!-- Example listing structure. In your real page, repeat/list via server-side rendering. Each listing needs data-id and .gallery element with data-images (optional) -->
  <article class="listing" data-id="listing-123">
    <div class="gallery" tabindex="0" aria-label="Image gallery for Business A">
      <button class="nav-btn left" aria-label="Previous image">◀</button>
      <img class="main" src="images/business-a-1.jpg" alt="Business A main photo" loading="lazy">
      <button class="nav-btn right" aria-label="Next image">▶</button>
      <div class="thumbs" aria-hidden="false">
        <img data-src="images/business-a-1.jpg" alt="Thumbnail 1" loading="lazy">
        <img data-src="images/business-a-2.jpg" alt="Thumbnail 2" loading="lazy">
        <img data-src="images/business-a-3.jpg" alt="Thumbnail 3" loading="lazy">
      </div>
    </div>

    <div class="meta">
      <h2>Business A</h2>
      <p>Great local shop at your service.</p>
      <div class="rating" aria-live="polite">
        <span class="stars" role="radiogroup" aria-label="Rate this business">
          <span class="star" data-value="1" role="radio" aria-checked="false">★</span>
          <span class="star" data-value="2" role="radio" aria-checked="false">★</span>
          <span class="star" data-value="3" role="radio" aria-checked="false">★</span>
          <span class="star" data-value="4" role="radio" aria-checked="false">★</span>
          <span class="star" data-value="5" role="radio" aria-checked="false">★</span>
        </span>
        <span class="rating-value sr-only">Not rated</span>
      </div>
    </div>
  </article>

  <script>
    // Utility: inline SVG fallback placeholder (data URL)
    const PLACEHOLDER_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400" viewBox="0 0 600 400">' +
      '<rect width="600" height="400" fill="#eee"/>' +
      '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#aaa" font-family="Arial, Helvetica, sans-serif" font-size="24">Image not available</text>' +
      '</svg>'
    );

    // Apply fallback when images error
    function applyImageFallback(img){
      if(!img) return;
      img.addEventListener('error', function handler(){
        img.removeEventListener('error', handler);
        img.src = PLACEHOLDER_SVG;
      });
      // If data-src exists and src is empty, set it now
      if(img.dataset && img.dataset.src && (!img.src || img.src.trim()==='')){
        img.src = img.dataset.src;
      }
    }

    // Initialize all listings
    document.addEventListener('DOMContentLoaded', () =>{
      const listings = document.querySelectorAll('.listing');
      listings.forEach(initListing);
    });

    function initListing(listing){
      const id = listing.dataset.id || ('listing-' + Math.random().toString(36).slice(2,9));
      const gallery = listing.querySelector('.gallery');
      const main = gallery.querySelector('.main');
      const thumbs = gallery.querySelector('.thumbs');
      const thumbImgs = thumbs ? Array.from(thumbs.querySelectorAll('img')) : [];
      const prevBtn = gallery.querySelector('.nav-btn.left');
      const nextBtn = gallery.querySelector('.nav-btn.right');

      // Load thumbnail images (support data-src lazy pattern)
      thumbImgs.forEach((t, idx) =>{
        if(t.dataset && t.dataset.src){
          t.src = t.dataset.src;
        }
        applyImageFallback(t);
        t.addEventListener('click', ()=>{
          setMainImage(main, t.src);
          setActiveThumb(thumbImgs, idx);
        });
      });

      // If no thumbnails or only one, hide the thumbs container but ensure main image uses src
      if(!thumbImgs.length || thumbImgs.length <= 1){
        if(thumbs) thumbs.classList.add('hidden');
      }

      // Ensure main has fallback handling
      applyImageFallback(main);

      // Support previous/next
      let currentIndex = 0;
      function setActiveThumb(list, i){
        list.forEach((t, idx)=>{
          t.classList.toggle('active', idx===i);
          t.setAttribute('aria-pressed', idx===i);
        });
        currentIndex = i;
      }

      function setMainImage(mainEl, src){
        if(!src) return;
        mainEl.src = src;
      }

      if(thumbImgs.length){
        // default to first thumb if main equals placeholder or different
        let initial = thumbImgs.findIndex(t=>t.src && t.src===main.src);
        if(initial === -1) initial = 0;
        setMainImage(main, thumbImgs[initial].src);
        setActiveThumb(thumbImgs, initial);
      }

      function showNext(){
        if(!thumbImgs.length) return;
        const next = (currentIndex + 1) % thumbImgs.length;
        setMainImage(main, thumbImgs[next].src);
        setActiveThumb(thumbImgs, next);
      }
      function showPrev(){
        if(!thumbImgs.length) return;
        const prev = (currentIndex - 1 + thumbImgs.length) % thumbImgs.length;
        setMainImage(main, thumbImgs[prev].src);
        setActiveThumb(thumbImgs, prev);
      }

      if(nextBtn) nextBtn.addEventListener('click', showNext);
      if(prevBtn) prevBtn.addEventListener('click', showPrev);

      // Keyboard navigation when gallery focused
      gallery.addEventListener('keydown', (ev)=>{
        if(ev.key === 'ArrowRight') { showNext(); ev.preventDefault(); }
        if(ev.key === 'ArrowLeft') { showPrev(); ev.preventDefault(); }
      });

      // Swipe support using pointer events (works for touch and mouse)
      let pointerDown = false, startX = 0, lastX = 0;
      gallery.addEventListener('pointerdown', (ev)=>{
        pointerDown = true; startX = ev.clientX; lastX = startX; gallery.setPointerCapture(ev.pointerId);
      });
      gallery.addEventListener('pointermove', (ev)=>{
        if(!pointerDown) return; lastX = ev.clientX;
      });
      gallery.addEventListener('pointerup', (ev)=>{
        if(!pointerDown) return; pointerDown = false; const diff = ev.clientX - startX;
        const threshold = 40; // px
        if(diff > threshold) showPrev();
        else if(diff < -threshold) showNext();
      });
      gallery.addEventListener('pointercancel', ()=>{ pointerDown = false; });

      // Ratings using localStorage
      const stars = listing.querySelectorAll('.star');
      const ratingValueEl = listing.querySelector('.rating-value');
      const storageKey = 'listing_rating_' + id;
      // Apply saved rating
      let saved = localStorage.getItem(storageKey);
      if(saved){
        highlightStars(stars, parseInt(saved,10));
        if(ratingValueEl) ratingValueEl.textContent = 'Rated ' + saved + ' out of 5';
      } else {
        if(ratingValueEl) ratingValueEl.textContent = 'Not rated';
      }

      stars.forEach((s, i)=>{
        const val = parseInt(s.dataset.value,10);
        s.addEventListener('click', ()=>{
          localStorage.setItem(storageKey, val);
          highlightStars(stars, val);
          if(ratingValueEl) ratingValueEl.textContent = 'Rated ' + val + ' out of 5';
        });
        s.addEventListener('keydown', (ev)=>{
          if(ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); s.click(); }
        });
      });

      function highlightStars(list, value){
        list.forEach((el)=>{
          const v = parseInt(el.dataset.value,10);
          const sel = v <= value;
          el.classList.toggle('selected', sel);
          el.setAttribute('aria-checked', sel ? 'true' : 'false');
        });
      }

    }

  </script>
</body>
</html>
